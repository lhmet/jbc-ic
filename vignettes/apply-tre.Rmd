---
title: "Aplicação do TRE"
output: 
  html_notebook: 
    number_sections: yes
    toc: yes
---

# Pré-configurações

```{r, message=FALSE, warning=FALSE}
# Limpando área
rm(list = ls())

# Carregando pacotes necessários
easypackages::libraries(
  c("dplyr", "tidyverse", "ggfortify", "lubridate", "modelr", "fs")
  )

# Carregando scripts necessários
source("../R/network-dists.R")
source("../R/get-aws-neighborhood.R")
source("../R/daily_summary.R")
source("../R/select-data-SRT.R")

source("../R/check_aws_srt_feasibility.R")
source("../R/add_intervals.R")
source("../R/utils.R")
source("../R/spatial_regression_test-v2.R")

```

# Parâmetros

```{r}
M = 10
interval_size = 60
aws_target = "A882"
aws_variable = "tavg" 
perc_ref = 50 
r2_threshold = 0.55  
```


# Dados necessários

Metadados das EMAs

```{r}
meta_data <- rio::import("../output/summary_80.rds") %>% as_tibble
meta_data
```

tabela de vizinhança entre as EMAs.

```{r}
neigh <- get_aws_neighborhood(meta_data, outfile = NULL)
neigh
```



Dados diários 

```{r}
daily_data <- rio::import("../output/s08_data_sel.rds") %>% 
  # daily averages
  daily_summary(col_vars = aws_variable)
daily_data
```


Dados diários com intervalo e em formato amplo.

```{r}
interval_data <- daily_data %>%
  add_intervals(interval_size = 60) #%>%
  #spread(site, !!aws_variable)
interval_data
```


  
  

Seleção de dados para aplicação do TRE à todas EMAs.

Códigos de todas EMAs:
```{r}
(targets <- unique(interval_data$site))
```

Dados de todas EMAs:

```{r}
tre_data <- map_df(
  targets,
  ~select_data_SRT(
    data = interval_data,
    neighbors = neigh,
    aws_code = .,
    m = M
  )
) %>%  arrange_vars(c("target" = 1))
#filter(tre_data, target == "A872") %>% View()

tre_data

# todos sites tem 10 EMAs vizinhas
tre_data %>%
  group_by(target) %>%
  summarise(nsites_difere = n_distinct(site)) %>%
  distinct(nsites_difere) 
```

Combinações possíveis entre pares de EMAs.

```{r}
aws_combs <- tre_data %>%
  select(site) %>%
  distinct() %>%
  pull() %>%
  combn(m = 2) %>%
  t() %>%
  as_tibble() %>%
  set_names(c("aws1", "aws2"))
aws_combs
```



```{r}

map_df(
  targets,
  function(itarget) {
    #  itarget = "A822"
    
    # EMAs vizinhas por proximidade
    aws_ord <- stations_neighbors(neigh, aws_id = itarget, M = M)

    # Dados
    data_int_wide <- tre_data %>%
      # dados da target
      filter(., target == itarget) %>%
      # formato amplo
      spread(site, !!aws_variable) %>%
      # ordena cols por proximidade
      select(target:int, one_of(aws_ord))
    
    # Combinações da alvo com as vizinhas
    
    
  }
)

```
 

#tre_data %>% filter(!is_target)
# aninha dados para o tre agrupando por target
by_target_int <- tre_data %>% 
  group_by(target, int) %>%
  group_nest()
by_target_int[["data"]][[1]]

teste1 <- by_target_int[c(1, nrow(by_target_int)), ] %>%
  mutate(.,
    data = map(
      .x = data,
      .f = tidyr::spread,
      site,
      !!aws_variable
    )
  )

teste1 %>%
mutate(., viz = code_target(.))


teste1 %>%
  mutate(viz = stations_neighbors(neigh, aws_id = .y)) %>%
  mutate(data_wide_ord = map2(
    .x = data,
    .y = dummy,
    .f = dplyr::select,
    .x,
    one_of(stations_neighbors(neigh, aws_id = .y))
  ))

  

tre_data %>%
  group_split(target)
  


library(magrittr)

# para um intervalo
by_target_int[["data"]][[1]] %>%
   stations_neighbors2(.,
          neighbors = neigh, 
          M = M
          )
  code_target(.) %>% print() %>%
  # estrutura dados em formato requerido
  spread(site, !!aws_variable)

```




stations_neighbors(neighbors = neigh, aws_id = aws_target, M = M)

f <- function(X) filter(X, is_target) %>% pull(site) %>% first()
f(tmp[["data"]][[1]])

# dados para o tre em formato wide 
tmp2 <- mutate(tmp[c(1, nrow(tmp)),],
  data = map(
    .x = data,
    .f = tidyr::spread,
    site,
    !!aws_variable
  ),
  id = map(data, ~f(.x))
  )


  )
  # ordenando por proximidade a alvo
  data = map(
    .x = data,
    .f = dplyr::select,
    one_of(
      c("date", "int", 
        stations_neighbors(
          neighbors = neigh, 
          aws_id = dplyr::filter(data, is_target) %>% pull(site) %>% first(),
          M = M
          )
        )
    )
  ),
)
tmp2[["data"]][[1]]
tmp2[["id"]]
dplyr::filter(tmp[["data"]][[1]], is_target) %>% pull(site) %>% first()
tmp2[["data"]][[2]]

#neigh %>% filter(ref == aws_code) %>% head(10) %>% pull(aux)
```

```{r}
tmp
```


# Aplicação do TRE


Seleção dos dados diários.


```{r}
aws_target <- "A882"

check_disp_int_target <- filter(check_disp_int_inmet_ok, target == aws_target) %>%
  unnest()

neighbors_o <- c(aws_target, unique(check_disp_int_target$neighbors_checked))

data %>%
  dplyr::filter(
    site %in% neighbors_o,
    int %in% unique(check_disp_int_target$int)
  ) %>%
  spread(site, variable) %>%
  select(date, int, one_of(neighbors_o))

```


```{r}
# para cada ref 
#      roda teste espacial
```


<!-- Dados estruturados com formato sililar ao do exemplo de aplicação do método. O formato dos dados é com a data na 1ª coluna, a EMA de referência na 2ª coluna e as EMAs vizinhas nas demais colunas. -->

