---
title: "Seleção do período de análise dados das EMA do INMET"
author: "Jônatan Tatsch"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_notebook: 
    toc: yes
  html_document:
    fig_caption: yes
    fig_width: 6
    highlight: kate
    keep_md: yes
    number_sections: yes
    toc: yes
---


# Introdução 

Este documento relata os critérios utilizados para definição do período de dados para aplicação dos testes de controle de qualidade da temperatura do ar. Como critério inicial serão selecionadas estações meteorológicas automáticas (EMA) dos locais com pelo menos 4 anos de dados (podem ser descontínuos). 

As etapas para seleção do período são:

- carregar os dados

- regularizar as séries temporais de cada EMA para garantir que todas tenham 24 h em cada dia e 365 (ou 366 dias, se ano bissexto) em cada ano

- determinar o período de dados de cada EMA (n° de anos)

- quantificar o número de dados válidos (não faltantes) para cada EMA


# Pacotes, funções e pré-configurações

Carregando pacotes necessários.

```{r setup}
# limpa espaço de trabalho
rm(list = ls()) 
# carrega pacotes necessários
pacotes <- c("knitr", "tidyverse", "lubridate", "openair", "stringr")
easypackages::libraries(pacotes)
# configura chuncks
# carrega scripts necessários
source("../R/gaps.R")
source("../R/utils.R")
source("../R/complete_dates.R")

#detach("package:raster", unload = TRUE)
```

Os dados são armazenados usando o Tempo Universal Coordenado [UTC](https://pt.wikipedia.org/wiki/Tempo_Universal_Coordenado). Portanto, podemos definir esse horário como padrão nessa sessão do R. Assim qualquer conversão ou operação com datas e horários usando objetos [POSIX](https://stat.ethz.ch/R-manual/R-devel/library/base/html/DateTimeClasses.html) serão realizadas em UTC.

```{r chunk1}
# definindo globalmente tz = "UTC"
Sys.setenv(TZ = "UTC")
```

# Dados


```{r chunk4}
# carregar os metadados (rds com coordenadas e nomes das EMA)
tar_info <- readRDS("../data/info_inmet_sul_2000_2016.rds")
tar_info
# carregar dados meteorológicos das EMA
tar_data <- readRDS("../data/dataSel_inmet_sul_localtime.rds")
glimpse(tar_data)
```

Garantindo que as séries contenham 24 horas em cada dia.

```{r}

```



# Período de dados

## Ranking de falhas

Antes de determinar o período de dados de cada EMA é preciso remover EMAs que conhenham muitos dados faltantes. Isso geralmente ocorre para EMAs inseridas recentemente no conjunto de dados. EMas que contenham somente dados faltantes devem ser desconsideradas do conjunto de dados.

```{r, }
# ranking de falhas das EMAs
rank_falt <- tar_data %>%
  group_by(site) %>%
  summarise(N = n(), 
            falt = n_NA(tair), 
            falt_perc = percent_NA(tair)) %>%
  arrange(desc(falt_perc)) %>%
  # combinando com info para saber nome das EMAs
  left_join(select(tar_info, site, name), by = "site")
rank_falt
not_informative <- rank_falt %>%
  filter(N == falt)
not_informative
```

Removendo EMAs sem dados.

```{r}
glimpse(tar_data)
tar_data <- tar_data %>%
  filter(! site %in% not_informative$site)
glimpse(tar_data)
```

## Período de dados

```{r}
tar_periods <- tar_data %>%
  group_by(site) %>%
  summarise(sdate = as.Date(min(date)) # data inicial
           ,edate = as.Date(max(date)) # data final
           ,period = round(time_length(edate-sdate, unit = "year"), 1))  %>% # período
            # desagrupando por site
            ungroup() %>%
  arrange(desc(period)) %>%
  # combinando com info para saber nome das EMAs
  left_join(select(tar_info, site, name, state), by = "site")
tar_periods
```



# Resumo de dados ausentes

Quantificar a quantidade de dados faltantes por EMA.

```{r , include = FALSE}
safe_dlg <- safely(date_longest_gap)
# investigando problema no gaps
sites <- unique(tar_data$site)
gp <- plyr::llply(sites, 
            function(isite){
              cat(isite, "\n")
              x <- filter(tar_data, site == isite)
              #gaps(x$tair)
              #date_longest_gap(x$tair, x$date)
              safe_dlg(x$tair, x$date)
            })
# EMA sem falhas
d <-  filter(tar_data, site == sites[87]) #%>% View()
  #timePlot(d, "tair", date.format = "%b-%d\n%Y")
gaps(d$tair)
# EMA com falhas no início
d <-  filter(tar_data, site == sites[86]) #%>% View()
gaps(d$tair)
# problema de warnings
# the condition has length > 1 and only the first element will be used
d <-  filter(tar_data, site == "A818") #%>% View()
gaps(d$tair)
longest_gap(d$tair)
date_longest_gap(d$tair,d$date)

```

## Estatísticas gerais

```{r}
tar_hly_summary <- tar_data %>%
  group_by(site) %>%
  dplyr::summarise(tavg = round(mean(tair,na.rm = TRUE), 1), # temp média
                   tmax_abs = max(tair, na.rm = TRUE),
                   tmin_abs = min(tair, na.rm = TRUE),
                   #dtr_max = tmax-tmin, # amplitude térmica máxima
                   # % de dados faltantes
                   missing = round(percent_NA(tair), 1),
                   # tamnho da falha mais longa
                   long_gap = longest_gap(tair),
                   #data de início da maior falha
                   date_slg = date_longest_gap(tair, date))  %>%
  # desagrupando por site
  ungroup() %>%
  # combinando com a tabela de informações das EMA
  left_join(select(tar_info, site, name), by = "site") %>%
  arrange_vars(c("name" = 2))
tar_hly_summary
```

## Estatísticas térmicas diárias.

```{r, include= FALSE}
summary(tar_data)
filter(tar_data, site == "A801") %>%
  selectByDate(start = "2001-01-19", end = "2001-01-23")
#filter(tar_daily, site == "A801", date >= as.Date("2001-01-19") | date <= as.Date("2001-01-23"))

```


```{r}
# medias diarias
tar_daily <- tar_data %>%
  group_by(site, day = as.Date(date)) %>%
  dplyr::summarise(tmax_d = max(tair, na.rm = TRUE),
                   tmin_d = min(tair, na.rm = TRUE),
                   tavg_d = mean(tair, na.rm = TRUE),
                   dtr_d = tmax_d - tmin_d,
                   n_data = sum(!is.na(tair))) %>%
  ungroup() %>%
  mutate_at(vars(tmax_d:n_data), funs(replace_inf))
tar_daily

tar_daily_summary <- tar_daily %>%
  group_by(site) %>%
   summarise_at(vars(tmax_d:n_data), mean, na.rm = TRUE) %>%
   ungroup() %>%
  mutate_at(vars(tmax_d:n_data), round, digits = 1) %>%
  rename("n_avg" = n_data)
tar_daily_summary
```



# Combinando informações 

```{r}
tar_summary <- tar_periods %>%
  full_join(select(tar_hly_summary, -name), by = "site") %>%
  arrange_vars(c("name" = 2, "state" = 3)) %>%
  full_join(tar_daily_summary, by = "site")
tar_summary
```

```{#r}
tar_summary_file <- "tar_summary_inmet_sul.rds"
saveRDS(tar_summary_file, file = file.path("../output", tar_summary_file))
```


# Seleção do período

O controle de qualidade será aplicado a um período de dados comum a todas EMAs de pelo menos 4 anos.

```{r}
tar_data_sel <- tar_data %>%
  selectByDate(year = 2008:2016)
# EMAs com pelo menos 4 anos (sites selecionados)
sites_sel <- tar_summary %>%
  filter(period >= 4) %>%
  select(site) %>%
  pull()
sites_sel
# filtrar dados só com as EMAs do sites_sel
tar_data_sel <- filter(tar_data_sel, site %in% sites_sel)
head(tar_data_sel)
saveRDS(tar_data_sel, file = "../output/tar_data_sel_inmet_sul.rds")
```


