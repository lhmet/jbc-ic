---
title: "Controle de qualidade 1 - Limites de intervalo de variaçao baseado nos extremos climatológicos"
author: "Jônatan Tatsch"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_notebook:
    number_sections: yes
    toc: yes
  html_document:
    fig_caption: yes
    fig_width: 6
    keep_md: yes
    number_sections: yes
    toc: no
---

> QC1b - Teste dos limites do intervalo de variação baseado nos valores de temperatura do ar mínima e máxima absolutos registrados na estação climatológica mais próxima à EMA.

# Pré-requisitos


```{r setup, message=FALSE}
# clean-up
rm(list = ls()) 
# pacotes
pacotes <- c("knitr", "tidyverse", "lubridate", "openair", "stringr", 
             "magrittr", "kableExtra", "inmetr")
easypackages::libraries(pacotes)
# scripts 
source("../R/utils.R")
source("../R/temp-records-inmet.R")
source("../R/network-dists.R")
source("../R/gg_bubble.R")
Sys.setenv(TZ = "UTC")
#options(knitr.table.format = "html")
```

# Dados 

```{r}
# metadados do INMET corrigidos e atualizados.(see R/aws-inmet-metadata.R)
tar_info <- readRDS("../output/tar-info-inmet-2008-2016-4yrs-south.rds")
tar_info
# dados
data_file <- "../output/tar-data-inmet-2008-2016-4yrs-south.rds"
# prefixo para nome dos arquivos derivados desta etapa
prefix <- str_split(basename(data_file), "\\.") %>%
  unlist() %>%
  extract(1)
# importa dados
tar_data <- readRDS(data_file) %>%
  # só requer dados de tair
  select(date, site, tair, tmed) %>%
  arrange(site)
tar_data
```

## Preparação do conjunto de dados da rede destações auxiliar

Este teste de QC requer dados de temperatura do ar máxima e mínima absoluta das Estações Meteorológicas Convencionais (EMC) do INMET. Estes dados foram obtidos em http://www.inmet.gov.br/portal/index.php?r=clima/normaisClimatologicas.


### Metadados das EMC

```{r}
# records de temperatura
records_emc <- temp_records_inmet(file_tmx = "../data-raw/Temperatura-Maxima-Absoluta_NCB_1961-1990.xls",
                               file_tmn = "../data-raw/Temperatura-Minima-Absoluta_NCB_1961-1990.xls")
records_emc
# metadata
meta_emc <- inmetr::bdmep_meta %>%
  dplyr::rename("site" = id) %>%
  dplyr::filter(uf %in% c("RS", "SC", "PR"))
meta_emc
#with(meta_emc, plot(lon, lat, pch = 4))
```


### EMC mais próxima de cada EMA.


```{r}
dists <- network_dists(netw_ref = tar_info, 
                       netw_aux = meta_emc, 
                       dx_max = NA,
                       lonlat = TRUE)
# 5 closest
five_nearest <- dists %>%
  dplyr::group_by(ref) %>% 
  # rank
  dplyr::mutate(r = dense_rank(dis)) %>%
  dplyr::filter(r <= 5)
five_nearest
nearest <- filter(five_nearest, r == 1) %>%
  select(-r)
nearest
# summary_dists <- dists %>%
#   group_by(ref) %>%
#   summarise(N = n(), dmn = min(dis), dmx = max(dis), aux_dmn = aux[which.min(dis)])
# summary_dists %>% arrange(desc(dmn))
```

Tabela de extremos por EMA.

```{r}
left_join(nearest, )
```


# Produto 1

Conjunto de dados original com uma nova coluna nomeada como $varname\_qc_{i}$. $varname$ é o nome da variável a qual está sendo aplicado o teste de QC. $i$ é o número identificador do teste de QC e pode variar de $i=1,..,n$, onde $n$ é o nº de testes de QC.

A convenção dos identificadores de QC é definida em `vignettes/qc-definition.Rmd`. 

Neste caso a variável usada como rótulo identificador de dado suspeito será composto pela variável `tair` (temperatura do ar) e o identificador correspondente ao **teste de limites máximos e mínimos absolutos das séries históricas** (`qc1b`). A nova variável adicionada ao conjunto de dados original será nomeada `tair_qc1b` que assumirá os valores 

  - `tair_qc1b = 1`, dado não aprovado no teste `qc1b`, portanto é classificado como uma observação de `tair` **suspeita**
  
  - `tair_qc1b = 0`, dado aprovado no teste `qc1b`
  
```{r}
# identificador do qc
id_qc <- "1b"
# preparação dos dados para compatibilidade no join
nearest_stn_j <- mutate(ungroup(nearest), site = ref, ref = NULL, dis = NULL)
nearest_stn_j
records_emc_j <- rename(records_emc, "aux" = site)
records_emc_j
# qc1b, i = 1, teste de limites de variação baseado nas séries históricas
tar_data_j <- tar_data %>%
  mutate(month = lubridate::month(date)) %>%
  left_join(nearest_stn_j, by = "site") %>%
  left_join(records_emc_j, by = c("aux", "month"))
tar_data_j
#nrow(tar_data) == nrow(tar_data_qc)
tar_data_qc <- tar_data_j %>%
  mutate(qc = id_qc,
         tmed_qc1b = ifelse(tmed > tmax_abs | tmed < tmin_abs, 1, 0))
tar_data_qc
nrow(tar_data) == nrow(tar_data_qc)
``` 


