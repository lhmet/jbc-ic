---
title: Implmlentação do teste de QC espacial
output: html_notebook
---


# Pré-configurações

```{r}
# Limpando área
rm(list = ls())

# Carregando pacotes necessários
easypackages::libraries(c("tidyverse", "ggfortify", "lubridate", "modelr"))

# Carregando scripts necessários
source("../R/network-dists.R")
source("../R/utils.R")
```

# Dados

Como foi gerado estes dados.

```{r}
(var_data <- rio::import("../output/s08_data_sel.rds") %>% as_tibble) 
```

Metadados das EMA.

```{r}
(var_info <- rio::import("../output/summary_80.rds") %>% as_tibble)
```

# Cálculo de distâncias


```{r}
dists <- network_dists(
  netw_ref = var_info,
  netw_aux = var_info, 
  dx_max = NA,
  lon_lat = TRUE)
dists
```

A EMA de referência para teste será a A803, Santa Maria-RS, e suas 10 EMAs vizinhas mais próximas.

```{r}
n_emas_prox <- 10
EMA_dists <-
  dists %>%
  filter(ref == "A803") %>%
  arrange(dis) %>% 
  head(n_emas_prox + 1) # a própria ema inclusive
EMA_dists

```

Seleção de dados da EMA selecionada e suas vizinhas.

```{r}
EMA_data <- filter(var_data, site %in% EMA_dists$aux) %>%
  select(site, date, tavg)
```

Para um teste inicial selecionaremos apenas dados das 12 h. O método orinalmente foi aplicado a dados diários.

```{r}
EMA_data <- EMA_data %>%
  filter(hour(date) == 12)
```

Para definir a janela de aplicação do método seleciou-se arbitrariamente o dia **22/09/2016**. O tamanho da janela em torno do dia de referência será de 15 dias antes e depois da data central.

```{r}
select_day <- as.Date("2016-09-22")
## Selecionando um período de 15 dias antes e depois do dia escolhido
EMA_data <-
  EMA_data %>%
  filter(as.Date(date) >= (select_day - 15) & 
           as.Date(date) <= (select_day + 15))
EMA_data
#unique(EMA_data$site)
```


Vamos verificar a disponibilidade dos dados selecionados. Mantém-se somente EMAs com mais de 50% de dados válidos.

```{r}
disp_period <-
  EMA_data %>%
  group_by(site) %>% 
  summarise(
    tot_all = n(),
    tot_na = sum(!is.na(tavg)),
    perc_na = (tot_na/tot_all) * 100) %>%
  arrange(perc_na)

disp_gt_50 <- disp_period %>%
  filter(perc_na > 50)

EMA_data <- EMA_data %>%
  filter(site %in% disp_gt_50$site)
EMA_data
```

Estruturar dados no formato similar ao do exemplo de aplicação do método.

```{r}
data_wide <-
  EMA_data %>%
  mutate(
    hour = hour(date),
    date = as.Date(date)
    ) %>%
  spread(site, tavg) %>%
  select(-hour) %>%
  as.tibble()
data_wide
```

O formato dos dados é com a data na 1ª coluna, a EMA de referência na 2ª coluna e as EMAs vizinhas nas demais colunas.

```{r}
names(data_wide)[2] <- "x"
```


# Aplicação do teste

```{r}
# Aplicando o teste de regressão espacial aos dados selecionados
tab_by_station <-
  data_wide %>%
  #select(date:A883) %>%
  gather(y, tempf, -c(x, date)) %>%
  group_by(y) %>%
  nest()
tab_by_station
```

Modelo de regressão

```{r}
reg_model <- function(df) {
  lm(x ~ tempf, data = df)
  #lm(x ~ tempf, data = na.omit(df))
}
```

Aplicando a regressão entre a EMA de referência e cada EMA vizinha.


```{r}
tab_by_station <-
  tab_by_station %>%
  mutate(model = map(data, reg_model))
tab_by_station[["model"]]
```


Valores previstos.

```{r}
tab_by_station <-
  tab_by_station %>%
  mutate(
    pred = map2(data, model, add_predictions),  # x'
    resid = map2(data, model, add_residuals)    # x - x'
    )
tab_previstos <- unnest(tab_by_station, pred)
tab_previstos
summary(tab_previstos)
```

Qualidade do ajuste das regressões.

```{r}
tab_glance <-
  tab_by_station %>% 
  mutate(glance = map(model, broom::glance)) %>% 
  unnest(glance, .drop = TRUE)
tab_glance
```



```{r}
tab_by_station_norm <- tab_by_station %>%
  select(y, pred) %>%
  inner_join(., select(tab_glance, y, sigma)) %>%
  unnest(pred) %>%
  rename("xi" = pred) %>%
  mutate(xi_norm = xi/sigma^2)
tab_by_station_norm
```


```{r}
inv_sum_si2 <- sum(1/tab_glance$sigma^2)

# num d estações vizinhas
tab_N <- length(tab_glance$sigma)

# constante: s', linha 36, coluna 13, da tab2
tab_s_lin <- sqrt(tab_N/tab_inv_sum_si2)


tab_resultado <- select(tab_by_station_norm, y, date, xi_norm) %>%
  mutate(
    date = as.Date(date, "%m/%d/%Y"),
    # para não confundir a cabeça
    y = gsub("y", "xi_norm", y),
    y = as.numeric(as.factor(y))
  ) %>%
  spread(y, xi_norm) %>%
  setNames(c("date", paste0("xi_norm", names(.)[-1]))) %>%
  mutate(x_est = rowSums(select(., -1)) / inv_sum_si2)

tab_resultado 

```



